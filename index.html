<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced DataFrame Condition Builder</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            line-height: 1.6;
            color: #e1effe;
            background: linear-gradient(135deg, #0a0e1a 0%, #0f1629 25%, #1a237e 75%, #1565c0 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: linear-gradient(135deg, rgba(15, 23, 42, 0.95) 0%, rgba(30, 41, 59, 0.95) 100%);
            backdrop-filter: blur(15px);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
            border: 1px solid rgba(37, 99, 235, 0.2);
        }

        h1 {
            text-align: center;
            color: white;
            margin-bottom: 30px;
            font-size: 2.5rem;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.6);
            background: linear-gradient(135deg, #0d1b2a 0%, #1b263b 25%, #1e3a8a 75%, #2563eb 100%);
            padding: 3rem 0;
            border-radius: 0 0 1rem 1rem;
            box-shadow: 0 8px 32px rgba(37, 99, 235, 0.3);
            border-bottom: 1px solid rgba(59, 130, 246, 0.2);
            margin: -20px -20px 30px -20px;
        }

        .upload-area {
            border: 2px dashed #2563eb;
            border-radius: 15px;
            padding: 40px;
            text-align: center;
            margin-bottom: 30px;
            background: linear-gradient(135deg, rgba(15, 23, 42, 0.95) 0%, rgba(30, 41, 59, 0.95) 100%);
            backdrop-filter: blur(15px);
            transition: all 0.3s ease;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
        }

        .upload-area:hover {
            border-color: #3b82f6;
            box-shadow: 0 12px 40px rgba(37, 99, 235, 0.2);
        }

        .upload-area.dragover {
            border-color: #764ba2;
            background: rgba(118, 75, 162, 0.1);
            transform: scale(1.02);
        }

        .file-input {
            display: none;
        }

        .upload-btn {
            background: linear-gradient(135deg, #1d4ed8 0%, #1e40af 100%);
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
            box-shadow: 0 4px 15px rgba(29, 78, 216, 0.3);
        }

        .upload-btn:hover {
            background: linear-gradient(135deg, #1e40af 0%, #1e3a8a 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(29, 78, 216, 0.4);
        }

        .data-preview {
            margin: 20px 0;
            background: linear-gradient(135deg, rgba(15, 23, 42, 0.9) 0%, rgba(30, 41, 59, 0.9) 100%);
            backdrop-filter: blur(15px);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
            border: 1px solid rgba(37, 99, 235, 0.2);
        }

        .condition-builder {
            background: linear-gradient(135deg, rgba(15, 23, 42, 0.95) 0%, rgba(30, 41, 59, 0.95) 100%);
            backdrop-filter: blur(15px);
            border-radius: 15px;
            padding: 25px;
            margin: 20px 0;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
            border: 1px solid rgba(37, 99, 235, 0.2);
        }

        .expression-display {
            background: linear-gradient(135deg, rgba(30, 41, 59, 0.8) 0%, rgba(51, 65, 85, 0.8) 100%);
            backdrop-filter: blur(15px);
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            min-height: 60px;
            border: 2px solid rgba(30, 64, 175, 0.3);
            font-family: 'Courier New', monospace;
            font-size: 16px;
            line-height: 1.6;
            color: #e1effe;
        }

        .expression-display .token {
            display: inline-block;
            margin: 2px;
            padding: 5px 10px;
            border-radius: 20px;
            font-weight: bold;
        }

        .token.column {
            background: #1d4ed8;
            color: white;
        }

        .token.operator {
            background: #1e40af;
            color: white;
        }

        .token.value {
            background: #059669;
            color: white;
        }

        .token.logic {
            background: #dc2626;
            color: white;
        }

        .token.paren {
            background: #2563eb;
            color: white;
        }

        .controls-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .control-group {
            background: linear-gradient(135deg, rgba(30, 41, 59, 0.8) 0%, rgba(51, 65, 85, 0.8) 100%);
            backdrop-filter: blur(15px);
            padding: 20px;
            border-radius: 10px;
            border: 1px solid rgba(37, 99, 235, 0.2);
        }

        .control-group h3 {
            color: #93c5fd;
            margin-bottom: 15px;
            font-size: 1.2em;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #93c5fd;
        }

        .form-control {
            width: 100%;
            padding: 12px;
            border: 2px solid rgba(30, 64, 175, 0.3);
            border-radius: 8px;
            font-size: 14px;
            background: rgba(15, 23, 42, 0.9);
            color: #e1effe;
            transition: all 0.3s ease;
        }

        .form-control:focus {
            outline: none;
            border-color: #2563eb;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            transition: all 0.3s ease;
            margin: 5px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #1d4ed8 0%, #1e40af 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(29, 78, 216, 0.3);
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, #1e40af 0%, #1e3a8a 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(29, 78, 216, 0.4);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #374151 0%, #4b5563 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(75, 85, 99, 0.3);
        }

        .btn-secondary:hover {
            background: linear-gradient(135deg, #4b5563 0%, #6b7280 100%);
            transform: translateY(-2px);
        }

        .btn-success {
            background: linear-gradient(135deg, #059669 0%, #047857 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(5, 150, 105, 0.3);
        }

        .btn-success:hover {
            background: linear-gradient(135deg, #047857 0%, #065f46 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(5, 150, 105, 0.4);
        }

        .btn-warning {
            background: linear-gradient(135deg, #d97706 0%, #b45309 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(217, 119, 6, 0.3);
        }

        .btn-warning:hover {
            background: linear-gradient(135deg, #b45309 0%, #92400e 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(217, 119, 6, 0.4);
        }

        .btn-danger {
            background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(220, 38, 38, 0.3);
        }

        .btn-danger:hover {
            background: linear-gradient(135deg, #b91c1c 0%, #991b1b 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(220, 38, 38, 0.4);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .result-section {
            background: linear-gradient(135deg, rgba(15, 23, 42, 0.95) 0%, rgba(30, 41, 59, 0.95) 100%);
            backdrop-filter: blur(15px);
            border-radius: 15px;
            padding: 25px;
            margin: 20px 0;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
            border: 1px solid rgba(37, 99, 235, 0.2);
        }

        .result-section h3, .result-section h4 {
            color: #93c5fd;
            margin-bottom: 1rem;
        }

        .code-output {
            background: #0f172a;
            color: #e2e8f0;
            padding: 20px;
            border-radius: 10px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.6;
            overflow-x: auto;
            margin: 15px 0;
            border: 1px solid rgba(30, 64, 175, 0.3);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }

        .table-container {
            overflow-x: auto;
            margin: 20px 0;
            border-radius: 10px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
            border: 1px solid rgba(30, 64, 175, 0.3);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: linear-gradient(135deg, rgba(15, 23, 42, 0.9) 0%, rgba(30, 41, 59, 0.9) 100%);
            backdrop-filter: blur(15px);
        }

        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid rgba(30, 64, 175, 0.2);
            color: #e1effe;
        }

        th {
            background: linear-gradient(135deg, rgba(30, 41, 59, 0.95) 0%, rgba(51, 65, 85, 0.95) 100%);
            backdrop-filter: blur(10px);
            color: #93c5fd;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        tr:hover {
            background: rgba(37, 99, 235, 0.1);
        }

        .alert {
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            font-weight: 600;
            backdrop-filter: blur(15px);
        }

        .alert-success {
            background: linear-gradient(135deg, rgba(5, 150, 105, 0.2) 0%, rgba(4, 120, 87, 0.2) 100%);
            border-left: 4px solid #059669;
            color: #6ee7b7;
            border: 1px solid rgba(5, 150, 105, 0.3);
        }

        .alert-error {
            background: linear-gradient(135deg, rgba(220, 38, 38, 0.2) 0%, rgba(185, 28, 28, 0.2) 100%);
            border-left: 4px solid #dc2626;
            color: #fca5a5;
            border: 1px solid rgba(220, 38, 38, 0.3);
        }

        .alert-info {
            background: linear-gradient(135deg, rgba(6, 182, 212, 0.2) 0%, rgba(8, 145, 178, 0.2) 100%);
            border-left: 4px solid #06b6d4;
            color: #67e8f9;
            border: 1px solid rgba(6, 182, 212, 0.3);
        }

        .hidden {
            display: none;
        }

        .loading {
            text-align: center;
            padding: 20px;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        .pulse {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .paren-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin: 15px 0;
        }

        .logic-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin: 15px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🔧 Advanced DataFrame Condition Builder</h1>
        
        <!-- File Upload Section -->
        <div class="upload-area" id="uploadArea">
            <h3>📁 Upload Your Data File</h3>
            <p>Drag and drop your CSV or Excel file here, or click to browse</p>
            <p><small>Supported formats: .csv, .xlsx, .xls</small></p>
            <input type="file" id="fileInput" class="file-input" accept=".csv,.xlsx,.xls" />
            <button class="upload-btn" onclick="document.getElementById('fileInput').click()">Choose File</button>
        </div>

        <!-- Data Preview Section -->
        <div id="dataPreview" class="data-preview hidden">
            <h3>📊 Data Preview</h3>
            <div id="dataTable"></div>
            <div id="columnInfo"></div>
        </div>

        <!-- Condition Builder Section -->
        <div id="conditionBuilder" class="condition-builder hidden">
            <h2>🛠️ Advanced Condition Builder with Grouping</h2>
            <p>Build complex conditions with proper grouping and nesting. Create expressions like: <code>(A==B) AND [(C==D) OR (E==F)]</code></p>

            <!-- Current Expression Display -->
            <div class="form-group">
                <label>Current Expression:</label>
                <div id="expressionDisplay" class="expression-display">
                    <em>Start building your expression using the tools below...</em>
                </div>
            </div>

            <!-- Expression Building Controls -->
            <div class="controls-grid">
                <!-- Parentheses Controls -->
                <div class="control-group">
                    <h3>📐 Parentheses</h3>
                    <div class="paren-buttons">
                        <button class="btn btn-secondary" onclick="addToken('open_paren', '(')">(</button>
                        <button class="btn btn-secondary" onclick="addToken('close_paren', ')')">)</button>
                    </div>
                </div>

                <!-- Condition Builder -->
                <div class="control-group">
                    <h3>⚡ Add Condition</h3>
                    <div class="form-group">
                        <label for="conditionColumn">Column:</label>
                        <select id="conditionColumn" class="form-control" onchange="updateValueInput()">
                            <option value="">Select column...</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="conditionOperator">Operator:</label>
                        <select id="conditionOperator" class="form-control">
                            <option value="==">=</option>
                            <option value="!=">!=</option>
                            <option value=">">&gt;</option>
                            <option value="<">&lt;</option>
                            <option value=">=">&gt;=</option>
                            <option value="<=">&lt;=</option>
                            <option value="contains">contains</option>
                            <option value="startswith">starts with</option>
                            <option value="endswith">ends with</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="conditionValue">Value:</label>
                        <select id="conditionValueSelect" class="form-control hidden">
                            <option value="">Select value...</option>
                        </select>
                        <input type="text" id="conditionValueInput" class="form-control" placeholder="Enter value...">
                    </div>
                    <button class="btn btn-primary" onclick="addCondition()">Add Condition</button>
                </div>

                <!-- Logical Operators -->
                <div class="control-group">
                    <h3>🔗 Logical Operators</h3>
                    <div class="logic-buttons">
                        <button class="btn btn-warning" onclick="addToken('and', 'AND')">AND</button>
                        <button class="btn btn-warning" onclick="addToken('or', 'OR')">OR</button>
                    </div>
                </div>

                <!-- Result Configuration -->
                <div class="control-group">
                    <h3>📊 Result Configuration</h3>
                    <div class="form-group">
                        <label for="resultColumn">Result Column Name:</label>
                        <input type="text" id="resultColumn" class="form-control" value="condition_result" placeholder="Enter column name...">
                    </div>
                    <div class="form-group">
                        <label for="trueValue">Value if True:</label>
                        <input type="text" id="trueValue" class="form-control" value="True" placeholder="Enter true value...">
                    </div>
                    <div class="form-group">
                        <label for="falseValue">Value if False:</label>
                        <input type="text" id="falseValue" class="form-control" value="False" placeholder="Enter false value...">
                    </div>
                </div>
            </div>

            <!-- Action Buttons -->
            <div style="text-align: center; margin: 20px 0;">
                <button class="btn btn-danger" onclick="clearExpression()">🗑️ Clear Expression</button>
                <button class="btn btn-success" onclick="applyConditions()" id="applyBtn" disabled>✅ Apply Conditions</button>
            </div>
        </div>

        <!-- Results Section -->
        <div id="resultsSection" class="result-section hidden">
            <h3>📈 Results</h3>
            <div id="resultMessage"></div>
            <div id="resultTable"></div>
            
            <h4>🐍 Generated Python Code</h4>
            <div id="generatedCode" class="code-output"></div>
            
            <button class="btn btn-primary" onclick="downloadResults()">📥 Download Results</button>
        </div>
    </div>

    <script>
        let currentData = [];
        let columnTypes = {};
        let expressionTokens = [];

        // File upload handling
        document.getElementById('fileInput').addEventListener('change', handleFile);
        
        const uploadArea = document.getElementById('uploadArea');
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });
        
        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });
        
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFile({ target: { files: files } });
            }
        });

        function handleFile(event) {
            const file = event.target.files[0];
            if (!file) return;

            const fileName = file.name.toLowerCase();
            const isCSV = fileName.endsWith('.csv');
            const isExcel = fileName.endsWith('.xlsx') || fileName.endsWith('.xls');

            if (!isCSV && !isExcel) {
                showAlert('Please upload a CSV or Excel file (.csv, .xlsx, .xls).', 'error');
                return;
            }

            showAlert('Processing file...', 'info');

            const reader = new FileReader();
            
            if (isCSV) {
                reader.onload = function(e) {
                    Papa.parse(e.target.result, {
                        header: true,
                        dynamicTyping: true,
                        skipEmptyLines: true,
                        complete: function(results) {
                            if (results.errors.length > 0) {
                                showAlert('Error parsing CSV: ' + results.errors[0].message, 'error');
                                return;
                            }
                            
                            currentData = results.data;
                            processLoadedData();
                        }
                    });
                };
                reader.readAsText(file);
            } else if (isExcel) {
                reader.onload = function(e) {
                    try {
                        const workbook = XLSX.read(e.target.result, {
                            type: 'array',
                            cellDates: true,
                            cellNF: false,
                            cellText: false
                        });
                        
                        // Get the first worksheet
                        const firstSheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[firstSheetName];
                        
                        // Convert to JSON with header row
                        const jsonData = XLSX.utils.sheet_to_json(worksheet, {
                            header: 1,
                            defval: null,
                            blankrows: false
                        });
                        
                        if (jsonData.length < 2) {
                            showAlert('Excel file must contain at least one header row and one data row.', 'error');
                            return;
                        }
                        
                        // Convert array format to object format
                        const headers = jsonData[0];
                        const dataRows = jsonData.slice(1);
                        
                        currentData = dataRows.map(row => {
                            const obj = {};
                            headers.forEach((header, index) => {
                                obj[header] = row[index] !== null && row[index] !== undefined ? row[index] : '';
                            });
                            return obj;
                        }).filter(row => {
                            // Filter out completely empty rows
                            return Object.values(row).some(value => value !== '' && value !== null && value !== undefined);
                        });
                        
                        if (workbook.SheetNames.length > 1) {
                            showAlert(`Excel file contains ${workbook.SheetNames.length} sheets. Using first sheet: "${firstSheetName}".`, 'info');
                        }
                        
                        processLoadedData();
                        
                    } catch (error) {
                        showAlert('Error parsing Excel file: ' + error.message, 'error');
                    }
                };
                reader.readAsArrayBuffer(file);
            }
        }

        function processLoadedData() {
            if (currentData.length === 0) {
                showAlert('No data found in the file.', 'error');
                return;
            }
            
            // Clean column names (remove extra spaces, special characters)
            const cleanedData = currentData.map(row => {
                const cleanedRow = {};
                Object.keys(row).forEach(key => {
                    const cleanKey = key.toString().trim();
                    cleanedRow[cleanKey] = row[key];
                });
                return cleanedRow;
            });
            
            currentData = cleanedData;
            
            analyzeData();
            displayData();
            setupConditionBuilder();
            showAlert(`File uploaded successfully! ${currentData.length} rows loaded.`, 'success');
        }

        function analyzeData() {
            if (currentData.length === 0) return;
            
            const firstRow = currentData[0];
            columnTypes = {};
            
            Object.keys(firstRow).forEach(column => {
                const values = currentData.map(row => row[column])
                    .filter(val => val !== null && val !== undefined && val !== '' && val !== 0);
                
                if (values.length === 0) {
                    columnTypes[column] = {
                        type: 'categorical',
                        uniqueValues: [''],
                        uniqueCount: 1
                    };
                    return;
                }
                
                // Check if column is numeric
                const numericValues = values.filter(val => {
                    if (typeof val === 'number') return true;
                    if (typeof val === 'string') {
                        const trimmed = val.toString().trim();
                        return !isNaN(Number(trimmed)) && trimmed !== '';
                    }
                    return false;
                });
                
                const isNumeric = numericValues.length / values.length > 0.8; // 80% threshold
                
                if (isNumeric && values.length > 0) {
                    const convertedNumbers = numericValues.map(v => Number(v));
                    columnTypes[column] = {
                        type: 'numeric',
                        min: Math.min(...convertedNumbers),
                        max: Math.max(...convertedNumbers),
                        uniqueCount: new Set(convertedNumbers).size
                    };
                } else {
                    // Handle dates that might come from Excel
                    const dateValues = values.filter(val => {
                        if (val instanceof Date) return true;
                        if (typeof val === 'string') {
                            const dateTest = new Date(val);
                            return !isNaN(dateTest.getTime());
                        }
                        return false;
                    });
                    
                    const isDate = dateValues.length / values.length > 0.7;
                    
                    if (isDate) {
                        const uniqueValues = [...new Set(values.map(v => {
                            if (v instanceof Date) return v.toISOString().split('T')[0];
                            return new Date(v).toISOString().split('T')[0];
                        }))].slice(0, 100);
                        
                        columnTypes[column] = {
                            type: 'date',
                            uniqueValues: uniqueValues,
                            uniqueCount: new Set(values).size
                        };
                    } else {
                        const uniqueValues = [...new Set(values.map(v => v.toString()))].slice(0, 100);
                        columnTypes[column] = {
                            type: 'categorical',
                            uniqueValues: uniqueValues,
                            uniqueCount: new Set(values).size
                        };
                    }
                }
            });
        }

        function displayData() {
            const preview = document.getElementById('dataPreview');
            const tableContainer = document.getElementById('dataTable');
            const columnInfo = document.getElementById('columnInfo');
            
            // Create table
            let tableHtml = '<div class="table-container"><table><thead><tr>';
            Object.keys(currentData[0]).forEach(column => {
                tableHtml += `<th>${column}</th>`;
            });
            tableHtml += '</tr></thead><tbody>';
            
            // Show first 5 rows
            currentData.slice(0, 5).forEach(row => {
                tableHtml += '<tr>';
                Object.keys(row).forEach(column => {
                    tableHtml += `<td>${row[column] || ''}</td>`;
                });
                tableHtml += '</tr>';
            });
            
            tableHtml += '</tbody></table></div>';
            if (currentData.length > 5) {
                tableHtml += `<p><em>Showing first 5 rows of ${currentData.length} total rows</em></p>`;
            }
            
            tableContainer.innerHTML = tableHtml;
            
            // Create column info
            let infoHtml = '<h4>📋 Column Information</h4><div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">';
            Object.keys(columnTypes).forEach(column => {
                const info = columnTypes[column];
                const typeColor = info.type === 'numeric' ? '#48bb78' : info.type === 'date' ? '#4299e1' : '#ed8936';
                infoHtml += `<div style="background: rgba(102, 126, 234, 0.05); padding: 15px; border-radius: 8px; border: 1px solid rgba(102, 126, 234, 0.2);">`;
                infoHtml += `<strong>${column}</strong><br>`;
                infoHtml += `Type: <span style="color: ${typeColor}">${info.type}</span><br>`;
                infoHtml += `Unique values: ${info.uniqueCount}`;
                if (info.type === 'numeric') {
                    infoHtml += `<br>Range: ${info.min} - ${info.max}`;
                } else if (info.type === 'date') {
                    infoHtml += `<br>Date format detected`;
                }
                infoHtml += `</div>`;
            });
            infoHtml += '</div>';
            
            columnInfo.innerHTML = infoHtml;
            preview.classList.remove('hidden');
        }

        function setupConditionBuilder() {
            const columnSelect = document.getElementById('conditionColumn');
            columnSelect.innerHTML = '<option value="">Select column...</option>';
            
            Object.keys(columnTypes).forEach(column => {
                const option = document.createElement('option');
                option.value = column;
                const typeIcon = columnTypes[column].type === 'numeric' ? '🔢' : 
                               columnTypes[column].type === 'date' ? '📅' : '📝';
                option.textContent = `${typeIcon} ${column} (${columnTypes[column].type})`;
                columnSelect.appendChild(option);
            });
            
            document.getElementById('conditionBuilder').classList.remove('hidden');
        }

        function updateValueInput() {
            const column = document.getElementById('conditionColumn').value;
            const valueSelect = document.getElementById('conditionValueSelect');
            const valueInput = document.getElementById('conditionValueInput');
            
            if (!column) {
                valueSelect.classList.add('hidden');
                valueInput.classList.remove('hidden');
                return;
            }
            
            const columnInfo = columnTypes[column];
            
            if (columnInfo.type === 'categorical' && columnInfo.uniqueCount <= 50) {
                // Show dropdown for categorical variables with reasonable number of options
                valueSelect.innerHTML = '<option value="">Select value...</option>';
                columnInfo.uniqueValues.forEach(value => {
                    const option = document.createElement('option');
                    option.value = value;
                    option.textContent = value;
                    valueSelect.appendChild(option);
                });
                valueSelect.classList.remove('hidden');
                valueInput.classList.add('hidden');
            } else if (columnInfo.type === 'date' && columnInfo.uniqueCount <= 50) {
                // Show dropdown for date variables with reasonable number of options
                valueSelect.innerHTML = '<option value="">Select date...</option>';
                columnInfo.uniqueValues.forEach(value => {
                    const option = document.createElement('option');
                    option.value = value;
                    option.textContent = value;
                    valueSelect.appendChild(option);
                });
                valueSelect.classList.remove('hidden');
                valueInput.classList.add('hidden');
            } else {
                // Show text input for numeric or high-cardinality categorical/date
                valueSelect.classList.add('hidden');
                valueInput.classList.remove('hidden');
                
                if (columnInfo.type === 'numeric') {
                    valueInput.type = 'number';
                    valueInput.step = 'any';
                    valueInput.placeholder = `Enter number (${columnInfo.min} - ${columnInfo.max})`;
                } else if (columnInfo.type === 'date') {
                    valueInput.type = 'date';
                    valueInput.placeholder = 'Select date...';
                } else {
                    valueInput.type = 'text';
                    valueInput.placeholder = 'Enter value...';
                }
            }
        }

        function addToken(type, value) {
            expressionTokens.push({ type, value });
            updateExpressionDisplay();
            updateApplyButton();
        }

        function addCondition() {
            const column = document.getElementById('conditionColumn').value;
            const operator = document.getElementById('conditionOperator').value;
            const valueSelect = document.getElementById('conditionValueSelect');
            const valueInput = document.getElementById('conditionValueInput');
            
            let value;
            if (!valueSelect.classList.contains('hidden')) {
                value = valueSelect.value;
            } else {
                value = valueInput.value;
            }
            
            if (!column || !operator || !value) {
                showAlert('Please fill in all condition fields.', 'error');
                return;
            }
            
            // Convert value to appropriate type
            const columnInfo = columnTypes[column];
            if (columnInfo.type === 'numeric' && !isNaN(Number(value))) {
                value = Number(value);
            }
            
            expressionTokens.push({ type: 'column', value: column });
            expressionTokens.push({ type: 'operator', value: operator });
            expressionTokens.push({ type: 'value', value: value });
            
            updateExpressionDisplay();
            updateApplyButton();
            
            // Reset form
            document.getElementById('conditionColumn').value = '';
            document.getElementById('conditionOperator').value = '==';
            document.getElementById('conditionValueSelect').value = '';
            document.getElementById('conditionValueInput').value = '';
            updateValueInput();
        }

        function updateExpressionDisplay() {
            const display = document.getElementById('expressionDisplay');
            
            if (expressionTokens.length === 0) {
                display.innerHTML = '<em>Start building your expression using the tools below...</em>';
                return;
            }
            
            let html = '';
            expressionTokens.forEach(token => {
                let className = '';
                let displayValue = token.value;
                
                switch (token.type) {
                    case 'column':
                        className = 'column';
                        break;
                    case 'operator':
                        className = 'operator';
                        break;
                    case 'value':
                        className = 'value';
                        displayValue = typeof token.value === 'string' ? `"${token.value}"` : token.value;
                        break;
                    case 'and':
                    case 'or':
                        className = 'logic';
                        break;
                    case 'open_paren':
                    case 'close_paren':
                        className = 'paren';
                        break;
                }
                
                html += `<span class="token ${className}">${displayValue}</span>`;
            });
            
            display.innerHTML = html;
        }

        function updateApplyButton() {
            const applyBtn = document.getElementById('applyBtn');
            const hasConditions = expressionTokens.some(token => token.type === 'column');
            applyBtn.disabled = !hasConditions;
        }

        function clearExpression() {
            expressionTokens = [];
            updateExpressionDisplay();
            updateApplyButton();
        }

        function applyConditions() {
            if (expressionTokens.length === 0) {
                showAlert('Please build an expression first.', 'error');
                return;
            }

            const resultColumn = document.getElementById('resultColumn').value.trim();
            const trueValue = document.getElementById('trueValue').value;
            const falseValue = document.getElementById('falseValue').value;

            if (!resultColumn) {
                showAlert('Please enter a result column name.', 'error');
                return;
            }

            try {
                console.log('Starting condition application...');
                console.log('Expression tokens:', expressionTokens);
                
                // Validate expression structure
                const validation = validateExpression();
                if (!validation.isValid) {
                    showAlert(`Invalid expression: ${validation.error}`, 'error');
                    return;
                }

                console.log('Expression validation passed');

                // Apply conditions to data
                const condition = buildCondition();
                console.log('Condition built, sample results:', condition.slice(0, 5));
                
                if (!condition || condition.length !== currentData.length) {
                    throw new Error('Failed to build valid condition array');
                }

                // Create new data with result column
                const resultData = currentData.map((row, index) => {
                    const newRow = { ...row };
                    newRow[resultColumn] = condition[index] ? trueValue : falseValue;
                    return newRow;
                });

                console.log('Result data created, sample:', resultData.slice(0, 3));

                // Update current data
                currentData = resultData;

                // Update column types to include new column
                columnTypes[resultColumn] = {
                    type: 'categorical',
                    uniqueValues: [trueValue, falseValue],
                    uniqueCount: 2
                };

                // Generate Python code
                const pythonCode = generatePythonCode(resultColumn, trueValue, falseValue);

                // Display results
                displayResults(resultColumn, pythonCode);
                
                // Update the data preview to show the new column
                displayData();
                
                showAlert(`✅ Applied conditions successfully! Created column "${resultColumn}".`, 'success');

            } catch (error) {
                console.error('Error applying conditions:', error);
                showAlert(`Error applying conditions: ${error.message}`, 'error');
            }
        }

        function validateExpression() {
            if (expressionTokens.length === 0) {
                return { isValid: false, error: 'Expression is empty' };
            }

            // Check for balanced parentheses
            let parenCount = 0;
            for (const token of expressionTokens) {
                if (token.type === 'open_paren') parenCount++;
                if (token.type === 'close_paren') parenCount--;
                if (parenCount < 0) {
                    return { isValid: false, error: 'Unbalanced parentheses' };
                }
            }
            if (parenCount !== 0) {
                return { isValid: false, error: 'Unbalanced parentheses' };
            }

            // Check for complete conditions
            for (let i = 0; i < expressionTokens.length; i++) {
                const token = expressionTokens[i];
                if (token.type === 'column') {
                    if (i + 2 >= expressionTokens.length || 
                        expressionTokens[i + 1].type !== 'operator' || 
                        expressionTokens[i + 2].type !== 'value') {
                        return { isValid: false, error: 'Incomplete condition found' };
                    }
                }
            }

            return { isValid: true };
        }

        function buildCondition() {
            if (expressionTokens.length === 0) {
                return new Array(currentData.length).fill(false);
            }

            // Convert expression tokens to a more processable format
            const processedTokens = [];
            
            for (let i = 0; i < expressionTokens.length; i++) {
                const token = expressionTokens[i];
                
                if (token.type === 'column') {
                    // Process complete condition (column + operator + value)
                    if (i + 2 < expressionTokens.length && 
                        expressionTokens[i + 1].type === 'operator' && 
                        expressionTokens[i + 2].type === 'value') {
                        
                        const column = token.value;
                        const operator = expressionTokens[i + 1].value;
                        const value = expressionTokens[i + 2].value;
                        
                        const conditionResult = currentData.map(row => {
                            const cellValue = row[column];
                            
                            try {
                                switch (operator) {
                                    case '==':
                                        return cellValue == value;
                                    case '!=':
                                        return cellValue != value;
                                    case '>':
                                        return Number(cellValue) > Number(value);
                                    case '<':
                                        return Number(cellValue) < Number(value);
                                    case '>=':
                                        return Number(cellValue) >= Number(value);
                                    case '<=':
                                        return Number(cellValue) <= Number(value);
                                    case 'contains':
                                        return String(cellValue || '').toLowerCase().includes(String(value || '').toLowerCase());
                                    case 'startswith':
                                        return String(cellValue || '').toLowerCase().startsWith(String(value || '').toLowerCase());
                                    case 'endswith':
                                        return String(cellValue || '').toLowerCase().endsWith(String(value || '').toLowerCase());
                                    default:
                                        return false;
                                }
                            } catch (error) {
                                console.error(`Error evaluating condition for row:`, error);
                                return false;
                            }
                        });
                        
                        processedTokens.push({ type: 'condition', value: conditionResult });
                        i += 2; // Skip operator and value tokens
                    }
                } else if (token.type === 'and' || token.type === 'or' || 
                          token.type === 'open_paren' || token.type === 'close_paren') {
                    processedTokens.push(token);
                }
            }

            // If we only have one condition, return it directly
            if (processedTokens.length === 1 && processedTokens[0].type === 'condition') {
                return processedTokens[0].value;
            }

            // Process logical operations
            return evaluateExpression(processedTokens);
        }

        function evaluateExpression(tokens) {
            if (tokens.length === 0) {
                return new Array(currentData.length).fill(false);
            }

            // Simple left-to-right evaluation with parentheses support
            let result = null;
            let currentOperator = null;
            const stack = [];
            
            for (let i = 0; i < tokens.length; i++) {
                const token = tokens[i];
                
                if (token.type === 'open_paren') {
                    // Find matching closing parenthesis
                    let parenCount = 1;
                    let j = i + 1;
                    while (j < tokens.length && parenCount > 0) {
                        if (tokens[j].type === 'open_paren') parenCount++;
                        if (tokens[j].type === 'close_paren') parenCount--;
                        j++;
                    }
                    
                    // Recursively evaluate the expression inside parentheses
                    const subTokens = tokens.slice(i + 1, j - 1);
                    const subResult = evaluateExpression(subTokens);
                    
                    if (result === null) {
                        result = subResult;
                    } else if (currentOperator === 'and') {
                        result = result.map((val, idx) => val && subResult[idx]);
                        currentOperator = null;
                    } else if (currentOperator === 'or') {
                        result = result.map((val, idx) => val || subResult[idx]);
                        currentOperator = null;
                    }
                    
                    i = j - 1; // Skip to after the closing parenthesis
                } else if (token.type === 'condition') {
                    if (result === null) {
                        result = token.value;
                    } else if (currentOperator === 'and') {
                        result = result.map((val, idx) => val && token.value[idx]);
                        currentOperator = null;
                    } else if (currentOperator === 'or') {
                        result = result.map((val, idx) => val || token.value[idx]);
                        currentOperator = null;
                    }
                } else if (token.type === 'and') {
                    currentOperator = 'and';
                } else if (token.type === 'or') {
                    currentOperator = 'or';
                }
            }
            
            return result || new Array(currentData.length).fill(false);
        }

        function generatePythonCode(resultColumn, trueValue, falseValue) {
            let code = `import pandas as pd\nimport numpy as np\n\n`;
            code += `# Apply complex condition with grouping\n`;
            
            // Convert expression to Python
            let pythonExpr = '';
            for (const token of expressionTokens) {
                switch (token.type) {
                    case 'column':
                        pythonExpr += `df['${token.value}']`;
                        break;
                    case 'operator':
                        switch (token.value) {
                            case '==':
                                pythonExpr += ' == ';
                                break;
                            case '!=':
                                pythonExpr += ' != ';
                                break;
                            case '>':
                                pythonExpr += ' > ';
                                break;
                            case '<':
                                pythonExpr += ' < ';
                                break;
                            case '>=':
                                pythonExpr += ' >= ';
                                break;
                            case '<=':
                                pythonExpr += ' <= ';
                                break;
                            case 'contains':
                                pythonExpr = pythonExpr.replace(/df\['([^']+)'\]$/, "df['$1'].astype(str).str.contains");
                                break;
                            case 'startswith':
                                pythonExpr = pythonExpr.replace(/df\['([^']+)'\]$/, "df['$1'].astype(str).str.startswith");
                                break;
                            case 'endswith':
                                pythonExpr = pythonExpr.replace(/df\['([^']+)'\]$/, "df['$1'].astype(str).str.endswith");
                                break;
                        }
                        break;
                    case 'value':
                        if (pythonExpr.includes('.str.contains') || pythonExpr.includes('.str.startswith') || pythonExpr.includes('.str.endswith')) {
                            pythonExpr += `('${token.value}')`;
                        } else if (typeof token.value === 'string') {
                            pythonExpr += `'${token.value}'`;
                        } else {
                            pythonExpr += token.value;
                        }
                        break;
                    case 'and':
                        pythonExpr += ' & ';
                        break;
                    case 'or':
                        pythonExpr += ' | ';
                        break;
                    case 'open_paren':
                        pythonExpr += '(';
                        break;
                    case 'close_paren':
                        pythonExpr += ')';
                        break;
                }
            }
            
            code += `# Define the condition\n`;
            code += `condition = ${pythonExpr}\n\n`;
            code += `# Apply the condition using np.where\n`;
            code += `df['${resultColumn}'] = np.where(condition, '${trueValue}', '${falseValue}')\n`;
            
            return code;
        }

        function displayResults(resultColumn, pythonCode) {
            const resultsSection = document.getElementById('resultsSection');
            const resultTable = document.getElementById('resultTable');
            const generatedCode = document.getElementById('generatedCode');
            
            // Create results table showing ALL columns including the new one
            let tableHtml = `<h4>📊 Updated Data with New Column "${resultColumn}" (first 15 rows)</h4>`;
            tableHtml += '<div class="table-container"><table><thead><tr>';
            
            // Get all column names
            const allColumns = Object.keys(currentData[0]);
            
            allColumns.forEach(column => {
                const isNew = column === resultColumn;
                tableHtml += `<th${isNew ? ' style="background: linear-gradient(45deg, #48bb78, #38a169); animation: pulse 2s infinite;"' : ''}>${column}${isNew ? ' ✨ NEW' : ''}</th>`;
            });
            tableHtml += '</tr></thead><tbody>';
            
            // Show first 15 rows
            const rowsToShow = Math.min(15, currentData.length);
            for (let i = 0; i < rowsToShow; i++) {
                const row = currentData[i];
                tableHtml += '<tr>';
                allColumns.forEach(column => {
                    const isNew = column === resultColumn;
                    const cellValue = row[column] !== null && row[column] !== undefined ? row[column] : '';
                    tableHtml += `<td${isNew ? ' style="background: rgba(72, 187, 120, 0.15); font-weight: bold; border-left: 3px solid #48bb78;"' : ''}>${cellValue}</td>`;
                });
                tableHtml += '</tr>';
            }
            
            tableHtml += '</tbody></table></div>';
            if (currentData.length > rowsToShow) {
                tableHtml += `<p style="text-align: center; margin-top: 10px;"><em>Showing first ${rowsToShow} rows of ${currentData.length} total rows</em></p>`;
            }
            
            // Add summary statistics for the new column
            const trueCount = currentData.filter(row => row[resultColumn] === document.getElementById('trueValue').value).length;
            const falseCount = currentData.filter(row => row[resultColumn] === document.getElementById('falseValue').value).length;
            const totalCount = currentData.length;
            
            tableHtml += `<div style="margin-top: 20px; padding: 15px; background: rgba(72, 187, 120, 0.1); border-radius: 10px; border: 1px solid #48bb78;">`;
            tableHtml += `<h5>📈 Summary Statistics for "${resultColumn}":</h5>`;
            tableHtml += `<p><strong>Total Rows:</strong> ${totalCount}</p>`;
            tableHtml += `<p><strong>${document.getElementById('trueValue').value}:</strong> ${trueCount} rows (${(trueCount/totalCount*100).toFixed(1)}%)</p>`;
            tableHtml += `<p><strong>${document.getElementById('falseValue').value}:</strong> ${falseCount} rows (${(falseCount/totalCount*100).toFixed(1)}%)</p>`;
            tableHtml += `</div>`;
            
            resultTable.innerHTML = tableHtml;
            generatedCode.textContent = pythonCode;
            
            resultsSection.classList.remove('hidden');
            
            // Scroll to results
            resultsSection.scrollIntoView({ behavior: 'smooth' });
        }

        function downloadResults() {
            const csv = convertToCSV(currentData);
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.style.display = 'none';
            a.href = url;
            a.download = 'modified_dataframe.csv';
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
        }

        function convertToCSV(data) {
            if (data.length === 0) return '';
            
            const headers = Object.keys(data[0]);
            const csvContent = [
                headers.join(','),
                ...data.map(row => 
                    headers.map(header => {
                        const value = row[header];
                        if (typeof value === 'string' && (value.includes(',') || value.includes('"') || value.includes('\n'))) {
                            return `"${value.replace(/"/g, '""')}"`;
                        }
                        return value;
                    }).join(',')
                )
            ].join('\n');
            
            return csvContent;
        }

        function showAlert(message, type) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type}`;
            alertDiv.textContent = message;
            
            document.querySelector('.container').insertBefore(alertDiv, document.querySelector('.container').firstChild);
            
            setTimeout(() => {
                alertDiv.remove();
            }, 5000);
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Advanced DataFrame Condition Builder loaded');
        });
    </script>
</body>
</html>
